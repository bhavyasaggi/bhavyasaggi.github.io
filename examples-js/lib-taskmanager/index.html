<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
      Live Code
    </title>
    <meta name="description" content="Live Code">
    <meta name="robots" content="noindex">

    <script type="importmap">
      {
        "imports": {
          "react": "https://esm.sh/react@18.2.0",
          "react-dom": "https://esm.sh/react-dom@18.2.0",
          "react-dom/": "https://esm.sh/react-dom@18.2.0/",
          "@codesandbox/sandpack-react": "https://esm.sh/@codesandbox/sandpack-react@2.8.0"
        }
      }
    </script>

    <script defer type="module">
      import React from "react";
      import {createRoot} from "react-dom/client";
      import {Sandpack} from "@codesandbox/sandpack-react";

      const root = createRoot(document.getElementById("root"));
      const inputData = document.getElementById("default-input");
      const [
        template = "vanilla",
        layout = "preview"
      ] = (`vanilla-console` || "vanilla").split('-');
      const filename = {
        'react': '/App.js',
        'static': '/index.html',
        'vanilla': '/index.js'
      }[template];
      const autoAction = template !== "react"
      const sandpackComponent = React.createElement(Sandpack, {
        template,
        theme: "dark",
        files: {
          [filename]: inputData.value
        },
        options: {
          layout,
          autoRun: autoAction,
          autoReload: autoAction,
          skipEval: false,
          initMode: "user-visible",
          recompileMode: "delayed",
          recompileDelay: 300,
          showRefreshButton: true,
          showInlineErrors: true,
          showLineNumbers: true,
          editorWidthPercentage: 50,
          resizablePanels: false
        }
      }, null);
      inputData.value = '';
      root.render(sandpackComponent);
    </script>
  </head>

  <body style="margin:0;border:0;padding:0;outline:0;">
    <textarea id="default-input" hidden style="display:none;height:0;width:0;">
// [a,5], [b, 2], [c, 2, ab], [d, 1, ], [e, 2, cb]
// d, b, a, c, e, all done
var tasks = {
  a: {
    job: function (finish) {
      setTimeout(function () {
        console.log('a done')
        finish()
      }, 500)
    },
  },
  b: {
    job: function (finish) {
      setTimeout(function () {
        console.log('b done')
        finish()
      }, 200)
    },
  },
  c: {
    job: function (finish) {
      setTimeout(function () {
        console.log('c done')
        finish()
      }, 200)
    },
    dependencies: ['a', 'b'],
  },
  d: {
    job: function (finish) {
      setTimeout(function () {
        console.log('d done')
        finish()
      }, 100)
    },
    dependencies: [],
  },
  e: {
    job: function (finish) {
      setTimeout(function () {
        console.log('e done')
        finish()
      }, 200)
    },
    dependencies: ['c', 'b'],
  },
}

function Task({ id, job, deps, cb }) {
  this.id = id
  this.job = job
  this.cb = cb
  this.deps = (deps || []).reduce((acc, dep) => {
    acc[dep] = 0
    return acc
  }, {})
  // -1: Error
  // 0 : Unexec
  // 1 : Running
  // 2 : Finish
  this.status = 0
}
Task.prototype.notify = function (dep) {
  if (Object.hasOwnProperty.call(this.deps, dep)) {
    this.deps[dep] = 1
  }
  this.exec()
}
Task.prototype.exec = function () {
  if (Object.values(this.deps).every((dep) => dep === 1)) {
    this.job(this.cb)
  }
}

function TaskManager(taskObject, callback) {
  this.taskMap = {}
  this.taskMapListeners = {}

  const taskIds = Object.keys(taskObject)
  taskIds.forEach((id) => {
    const task = taskObject[id]
    const taskObj = (this.taskMap[id] = new Task({
      id,
      job: task.job,
      deps: task.dependencies,
      cb: () => this.notify(id),
    }))
    const taskDeps = task.dependencies || []
    taskDeps.forEach((taskDep) => {
      this.taskMapListeners[taskDep] = this.taskMapListeners[taskDep] || []
      this.taskMapListeners[taskDep].push(taskObj)
    })
  })
  // EndTask
  const endTask = new Task({
    id: taskIds.join(''),
    job: callback,
    deps: taskIds,
    cb: () => {},
  })
  this.taskMap[endTask.id] = endTask
  taskIds.forEach((taskId) => {
    this.taskMapListeners[taskId] = this.taskMapListeners[taskId] || []
    this.taskMapListeners[taskId].push(endTask)
  })
  //   console.log(">>>", this.taskMap)
  //   console.log("###", this.taskMapListeners)
}
TaskManager.prototype.notify = function (id) {
  if (this.taskMapListeners[id]) {
    this.taskMapListeners[id]
      .splice(0, this.taskMapListeners[id].length)
      .forEach((taskObj) => {
        //         console.log("NOTIFY EVENT FOR: "+id+" TO: "+taskObj.id)
        taskObj.notify(id)
      })
  }
}
TaskManager.prototype.exec = function () {
  Object.keys(this.taskMap).forEach((id) => {
    const taskObj = this.taskMap[id]
    const taskDeps = Object.keys(taskObj ? taskObj.deps : {})
    if (taskObj && !taskDeps.length) {
      //       console.log("NOTIFY EVENT FOR: _ TO: "+taskObj.id)
      taskObj.notify()
    }
  })
}

const taskManager = new TaskManager(tasks, () => console.log('All Done'))
taskManager.exec()
</textarea>
    <div id="root"></div>
  </body>
</html>
